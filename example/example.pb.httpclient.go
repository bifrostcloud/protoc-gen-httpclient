// Code generated by protoc-gen-httpclient. DO NOT EDIT.
package example

import (
	cb "github.com/bifrostcloud/protoc-gen-httpclient/pkg/go/client/circuit-breaker"

	"io"

	"net/url"

	basic "github.com/bifrostcloud/protoc-gen-httpclient/pkg/go/client/basic"

	"net/http"

	stacktrace "github.com/palantir/stacktrace"

	utils "github.com/bifrostcloud/protoc-gen-httpclient/pkg/go/utils"

	"reflect"

	"fmt"

	"encoding/json"

	"io/ioutil"

	"strings"
)

type RequestManipulator func(*http.Request) error

type ExampleServiceWithBasicAuth struct {
	Endpoint string
	Username string
	Password string
}

// NewExampleServiceWithBasicAuth - sets up a new ExampleService client with basic authentication scheme
func NewExampleServiceWithBasicAuth(username, password string) *ExampleServiceWithBasicAuth {
	return &ExampleServiceWithBasicAuth{
		Username: username,
		Password: password,
	}
}

func (srv *ExampleServiceWithBasicAuth) GetFoo(arg *FooRequest, rms []RequestManipulator, clientopts ...cb.Option) (*FooResponse, error) {
	c := cb.New(clientopts...)

	request, err := http.NewRequest(http.MethodGet, `http://localhost:8080/foo`, nil)
	if err != nil {
		return nil, stacktrace.Propagate(err, "[GET] request creation failed for ExampleService.GetFoo with input arg %v", arg)
	}

	jsonVal, err := json.Marshal(*arg)
	if err != nil {
		return nil, stacktrace.Propagate(err, "request marshalling to json failed for ExampleService.GetFoo with input arg %v", arg)
	}
	request.Body = ioutil.NopCloser(strings.NewReader(string(jsonVal)))

	request.Header.Set("User-Agent", "My-Agent")

	basicauth := utils.BasicAuth(srv.Username, srv.Password)
	request.Header.Set("Authorization", "Basic "+basicauth)
	for _, r := range rms {
		err := r(request)
		if err != nil {
			return nil, stacktrace.Propagate(err, "request modification failed for ExampleService.GetFoo with input arg %v", arg)
		}
	}
	response, err := c.Do(request)
	if err != nil {
		return nil, err
	}
	result := &FooResponse{}
	err = json.NewDecoder(response.Body).Decode(result)
	if err != nil {
		return nil, err
	}
	return result, nil
}

func (srv *ExampleServiceWithBasicAuth) PutBar(arg *BarRequest, body io.Reader, rms []RequestManipulator, clientopts ...basic.Option) (*BarResponse, error) {
	c := basic.New(clientopts...)

	request, err := http.NewRequest(http.MethodPut, `http://localhost:8080/bar`, body)
	if err != nil {
		return nil, stacktrace.Propagate(err, "[PUT] request creation failed for ExampleService.PutBar with input arg %v", arg)
	}

	jsonVal, err := json.Marshal(*arg)
	if err != nil {
		return nil, stacktrace.Propagate(err, "request marshalling to json failed for ExampleService.PutBar with input arg %v", arg)
	}
	request.Body = ioutil.NopCloser(strings.NewReader(string(jsonVal)))

	basicauth := utils.BasicAuth(srv.Username, srv.Password)
	request.Header.Set("Authorization", "Basic "+basicauth)
	for _, r := range rms {
		err := r(request)
		if err != nil {
			return nil, stacktrace.Propagate(err, "request modification failed for ExampleService.PutBar with input arg %v", arg)
		}
	}
	response, err := c.Do(request)
	if err != nil {
		return nil, err
	}
	result := &BarResponse{}
	err = json.NewDecoder(response.Body).Decode(result)
	if err != nil {
		return nil, err
	}
	return result, nil
}

func (srv *ExampleServiceWithBasicAuth) PostBaz(arg *BazRequest, body io.Reader, rms []RequestManipulator, clientopts ...basic.Option) (*BazResponse, error) {
	c := basic.New(clientopts...)

	request, err := http.NewRequest(http.MethodPost, `http://localhost:8080/baz`, body)
	if err != nil {
		return nil, stacktrace.Propagate(err, "[POST] request creation failed for ExampleService.PostBaz with input arg %v", arg)
	}

	if body == nil {
		if request.Form == nil {
			request.Form = url.Values{}
		}
		e := reflect.ValueOf(&arg).Elem()
		for i := 0; i < e.NumField(); i++ {
			key := e.Type().Field(i).Name
			if strings.HasPrefix(key, "XXX") {
				continue
			}
			value := e.Field(i).Interface()
			request.Form.Set(key, fmt.Sprintf("%v", value))
		}
		request.Body = ioutil.NopCloser(strings.NewReader(request.Form.Encode()))
		request.ContentLength = int64(len(request.Form.Encode()))
	}

	request.Header.Set("User-Agent", "My-Agent")

	basicauth := utils.BasicAuth(srv.Username, srv.Password)
	request.Header.Set("Authorization", "Basic "+basicauth)
	for _, r := range rms {
		err := r(request)
		if err != nil {
			return nil, stacktrace.Propagate(err, "request modification failed for ExampleService.PostBaz with input arg %v", arg)
		}
	}
	response, err := c.Do(request)
	if err != nil {
		return nil, err
	}
	result := &BazResponse{}
	err = json.NewDecoder(response.Body).Decode(result)
	if err != nil {
		return nil, err
	}
	return result, nil
}
